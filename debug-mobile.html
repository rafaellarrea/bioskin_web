<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIOSKIN - Debug M√≥vil</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container { 
            max-width: 100%; 
            background: white; 
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .blog-item { 
            background: #e9f7ef; 
            padding: 10px; 
            margin: 8px 0; 
            border-radius: 5px; 
            border-left: 4px solid #28a745;
        }
        .btn { 
            padding: 12px 20px; 
            margin: 8px 4px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .stats { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            border-left: 4px solid #2196f3;
        }
        .alert { 
            padding: 12px; 
            border-radius: 6px; 
            margin: 10px 0; 
        }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        h1, h2 { color: #333; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            overflow-x: auto; 
            border-radius: 4px; 
            font-size: 12px;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç BIOSKIN - Debug M√≥vil</h1>
        <p><strong>Dispositivo:</strong> <span id="device-info">Detectando...</span></p>
        <p><strong>Fecha:</strong> <span id="current-date"></span></p>
        
        <div class="section">
            <h2>üìä Estado del Sistema</h2>
            <div id="system-status" class="stats">Cargando...</div>
            <button class="btn btn-primary" onclick="loadAllData()">üîÑ Actualizar Todo</button>
        </div>
        
        <div class="section">
            <h2>üíæ LocalStorage (Este Dispositivo)</h2>
            <div id="localStorage-content">Verificando...</div>
            <button class="btn btn-danger" onclick="clearLocalStorage()">üóëÔ∏è Limpiar LocalStorage</button>
        </div>
        
        <div class="section">
            <h2>üåê Blogs desde Servidor</h2>
            <div id="server-blogs">Cargando...</div>
            <button class="btn btn-primary" onclick="loadServerBlogs()">üîÑ Recargar Servidor</button>
        </div>
        
        <div class="section">
            <h2>üîß Acciones de Reparaci√≥n</h2>
            <button class="btn btn-success" onclick="copyBlogsFromPublic()">üìã Copiar Blogs P√∫blicos</button>
            <button class="btn btn-success" onclick="generateTestBlog()">‚ú® Generar Blog de Prueba</button>
            <button class="btn btn-warning" onclick="syncLocalStorageToServer()">üîÑ Sincronizar a Servidor</button>
            <button class="btn btn-danger" onclick="migrateAllBlogs()">üöÄ MIGRAR TODOS LOS BLOGS</button>
        </div>
        
        <div class="section">
            <h2>üì± Informaci√≥n del Navegador</h2>
            <div id="browser-info">Cargando...</div>
        </div>
    </div>

    <script>
        const LOCALSTORAGE_KEY = 'bioskin_dynamic_blogs';
        
        // Informaci√≥n del dispositivo
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);
            
            let deviceType = 'Escritorio';
            if (isIOS) deviceType = 'iOS';
            else if (isAndroid) deviceType = 'Android';
            else if (isMobile) deviceType = 'M√≥vil';
            
            document.getElementById('device-info').textContent = deviceType;
            document.getElementById('current-date').textContent = new Date().toLocaleString('es-ES');
            
            document.getElementById('browser-info').innerHTML = `
                <div><strong>User Agent:</strong> ${userAgent}</div>
                <div><strong>Ancho pantalla:</strong> ${window.innerWidth}px</div>
                <div><strong>Alto pantalla:</strong> ${window.innerHeight}px</div>
                <div><strong>LocalStorage disponible:</strong> ${typeof(Storage) !== "undefined" ? 'S√≠' : 'No'}</div>
            `;
        }
        
        // Cargar datos de localStorage
        function loadLocalStorageBlogs() {
            try {
                const data = localStorage.getItem(LOCALSTORAGE_KEY);
                const blogs = data ? JSON.parse(data) : [];
                
                const container = document.getElementById('localStorage-content');
                
                if (blogs.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è LocalStorage Vac√≠o</strong><br>
                            No hay blogs almacenados en este dispositivo. Esto explica por qu√© solo ves 2 blogs.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ${blogs.length} blogs encontrados en localStorage</strong>
                    </div>
                    ${blogs.map(blog => `
                        <div class="blog-item">
                            <strong>${blog.title}</strong><br>
                            <small>Categor√≠a: ${blog.category} | Fecha: ${new Date(blog.publishedAt).toLocaleDateString('es-ES')}</small>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                document.getElementById('localStorage-content').innerHTML = `
                    <div class="alert alert-warning">Error leyendo localStorage: ${error.message}</div>
                `;
            }
        }
        
        // Cargar blogs del servidor
        async function loadServerBlogs() {
            try {
                // Usar el nuevo endpoint que lista TODOS los blogs
                const response = await fetch('/api/blogs/list-all');
                const data = await response.json();
                const container = document.getElementById('server-blogs');
                
                if (!data.success || !data.blogs || data.blogs.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ùå No hay blogs en servidor</strong><br>
                            Usa el bot√≥n "MIGRAR TODOS LOS BLOGS" para subirlos.
                        </div>
                    `;
                    return;
                }
                
                const { blogs, stats } = data;
                
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>üåê ${stats.total} blogs disponibles en servidor</strong><br>
                        üî• Din√°micos: ${stats.dynamic} | üìã Est√°ticos: ${stats.static}
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${blogs.slice(0, 10).map(blog => `
                            <div class="blog-item" style="background: ${blog.source === 'dynamic' ? '#e8f5e8' : '#f8f9fa'};">
                                <strong>${blog.title}</strong><br>
                                <small>
                                    üìÇ ${blog.category} | 
                                    üìÖ ${new Date(blog.publishedAt).toLocaleDateString('es-ES')} | 
                                    üè∑Ô∏è ${blog.source}
                                    ${blog.featured ? ' | ‚≠ê Destacado' : ''}
                                </small>
                            </div>
                        `).join('')}
                        ${blogs.length > 10 ? `<div style="text-align: center; padding: 10px; color: #666;">... y ${blogs.length - 10} blogs m√°s</div>` : ''}
                    </div>
                `;
            } catch (error) {
                document.getElementById('server-blogs').innerHTML = `
                    <div class="alert alert-warning">Error cargando servidor: ${error.message}</div>
                `;
            }
        }
        
        // Cargar estado del sistema
        function loadSystemStatus() {
            loadLocalStorageBlogs();
            const localBlogs = JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '[]');
            
            document.getElementById('system-status').innerHTML = `
                <div><strong>LocalStorage:</strong> ${localBlogs.length} blogs</div>
                <div><strong>URL actual:</strong> ${window.location.href}</div>
                <div><strong>Hora carga:</strong> ${new Date().toLocaleTimeString('es-ES')}</div>
            `;
        }
        
        // Limpiar localStorage
        function clearLocalStorage() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar localStorage?')) {
                localStorage.removeItem(LOCALSTORAGE_KEY);
                alert('LocalStorage limpiado');
                loadAllData();
            }
        }
        
        // Copiar blogs desde la p√°gina p√∫blica
        async function copyBlogsFromPublic() {
            try {
                alert('Intentando obtener blogs desde la p√°gina p√∫blica...');
                
                // Simular que tenemos algunos blogs de ejemplo
                const sampleBlogs = [
                    {
                        id: 'mobile-test-' + Date.now(),
                        title: 'Blog de Prueba M√≥vil - ' + new Date().toLocaleDateString(),
                        slug: 'blog-prueba-movil-' + Date.now(),
                        excerpt: 'Este es un blog de prueba creado desde el m√≥vil para verificar que el sistema funciona correctamente.',
                        content: 'Contenido de prueba generado desde dispositivo m√≥vil.',
                        category: 'medico-estetico',
                        author: 'Sistema M√≥vil',
                        publishedAt: new Date().toISOString(),
                        readTime: 3,
                        tags: ['prueba', 'm√≥vil'],
                        image: '/images/logo/logo1.jpg',
                        featured: false
                    }
                ];
                
                localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(sampleBlogs));
                alert('‚úÖ Blog de prueba creado en localStorage');
                loadAllData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Generar blog de prueba
        function generateTestBlog() {
            const testBlog = {
                id: 'test-' + Date.now(),
                title: 'Prueba desde ' + (navigator.userAgent.includes('Mobile') ? 'M√≥vil' : 'Escritorio'),
                slug: 'prueba-' + Date.now(),
                excerpt: 'Blog de prueba para verificar sincronizaci√≥n entre dispositivos.',
                content: 'Este blog fue creado para probar la sincronizaci√≥n.',
                category: 'tecnico',
                author: 'Sistema de Prueba',
                publishedAt: new Date().toISOString(),
                readTime: 2,
                tags: ['prueba'],
                image: '/images/logo/logo1.jpg',
                featured: false
            };
            
            const existingBlogs = JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '[]');
            existingBlogs.unshift(testBlog);
            localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(existingBlogs));
            
            alert('‚úÖ Blog de prueba agregado');
            loadAllData();
        }
        
        // Sincronizar localStorage con servidor
        async function syncLocalStorageToServer() {
            try {
                // Obtener blogs de localStorage
                const localStorageBlogs = JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '[]');
                
                if (localStorageBlogs.length === 0) {
                    alert('‚ùå No hay blogs en localStorage para sincronizar');
                    return;
                }
                
                alert(`üîÑ Sincronizando ${localStorageBlogs.length} blogs al servidor...`);
                
                // Enviar al endpoint de sincronizaci√≥n
                const response = await fetch('/api/blogs/sync-localStorage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        localStorageBlogs: localStorageBlogs
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Sincronizaci√≥n exitosa!\n\n` +
                          `üìä Procesados: ${result.results.processed}\n` +
                          `‚ú® Agregados: ${result.results.added}\n` +
                          `üîÑ Actualizados: ${result.results.updated}\n` +
                          `‚è≠Ô∏è Omitidos: ${result.results.skipped}`);
                    
                    // Recargar datos del servidor
                    loadServerBlogs();
                } else {
                    alert('‚ùå Error en sincronizaci√≥n: ' + result.message);
                }
                
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
                console.error('Error sincronizando:', error);
            }
        }
        
        // Migrar TODOS los blogs de localStorage al servidor
        async function migrateAllBlogs() {
            try {
                if (!confirm('‚ö†Ô∏è MIGRACI√ìN COMPLETA\n\n¬øEst√°s seguro de migrar TODOS los blogs de localStorage al servidor?\n\nEsto har√° que est√©n disponibles en todos los dispositivos.')) {
                    return;
                }
                
                // Obtener TODOS los blogs de localStorage
                const allLocalBlogs = JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '[]');
                
                if (allLocalBlogs.length === 0) {
                    alert('‚ùå No hay blogs en localStorage para migrar');
                    return;
                }
                
                alert(`üöÄ INICIANDO MIGRACI√ìN COMPLETA\n\nüìä Total de blogs: ${allLocalBlogs.length}\n\n‚è≥ Por favor espera...`);
                
                // Enviar todos los blogs al endpoint de migraci√≥n
                const response = await fetch('/api/blogs/migrate-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        blogs: allLocalBlogs
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`üéâ ¬°MIGRACI√ìN EXITOSA!\n\n` +
                          `üìä Total procesados: ${result.results.total}\n` +
                          `‚úÖ Agregados al servidor: ${result.results.added}\n` +
                          `‚è≠Ô∏è Ya exist√≠an: ${result.results.skipped}\n` +
                          `üî• Total en servidor: ${result.newTotal}\n\n` +
                          `üåê Ahora todos los blogs estar√°n disponibles en cualquier dispositivo!`);
                    
                    // Recargar para ver los cambios
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert('‚ùå Error en migraci√≥n: ' + result.message);
                }
                
            } catch (error) {
                alert('‚ùå Error de red: ' + error.message);
                console.error('Error migrando todos los blogs:', error);
            }
        }
        
        // Cargar todos los datos
        function loadAllData() {
            detectDevice();
            loadSystemStatus();
            loadServerBlogs();
        }
        
        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>