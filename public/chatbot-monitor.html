<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor Chatbot WhatsApp - BIOSKIN</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .header {
        padding: 20px 15px;
        border-radius: 0;
        margin-bottom: 15px;
      }
    }
    
    h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 24px;
      }
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .subtitle {
        font-size: 14px;
      }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 15px;
        padding: 0 10px;
      }
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    @media (max-width: 768px) {
      .stat-card {
        padding: 20px 15px;
        border-radius: 10px;
      }
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }

    @media (max-width: 768px) {
      .stat-card:hover {
        transform: none;
      }
    }
    
    .stat-icon {
      font-size: 36px;
      margin-bottom: 15px;
    }
    
    .stat-label {
      color: #999;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .stat-value {
      color: #333;
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-detail {
      color: #666;
      font-size: 13px;
    }
    
    .section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .section {
        padding: 20px 15px;
        border-radius: 0;
        margin-bottom: 15px;
      }
    }
    
    .section-title {
      color: #667eea;
      font-size: 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .section-title {
        font-size: 18px;
        margin-bottom: 15px;
      }
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .btn {
        padding: 10px 16px;
        font-size: 13px;
        width: 100%;
        margin-right: 0;
      }
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    @media (max-width: 768px) {
      .btn:hover {
        transform: none;
      }
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 768px) {
      .table-container {
        margin-left: -15px;
        margin-right: -15px;
        border-radius: 0;
      }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    @media (max-width: 768px) {
      table {
        font-size: 13px;
      }
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    @media (max-width: 768px) {
      th, td {
        padding: 8px 6px;
      }
    }
    
    th {
      background: #f8f9fa;
      color: #667eea;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
    }

    @media (max-width: 768px) {
      th {
        font-size: 10px;
      }
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .timestamp {
      color: #999;
      font-size: 12px;
      text-align: right;
      margin-top: 20px;
    }
    
    .webhook-type {
      font-family: 'Courier New', monospace;
      background: #f8f9fa;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .json-preview {
      background: #282c34;
      color: #abb2bf;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ Monitor Chatbot WhatsApp - BIOSKIN</h1>
      <p class="subtitle">Sistema de monitoreo en tiempo real del chatbot con IA</p>
    </div>

    <div class="stats-grid" id="statsGrid">
      <div class="loading">Cargando estad√≠sticas...</div>
    </div>

    <div class="section">
      <h2 class="section-title">
        <span>üìä</span> Paneles de Control
      </h2>
      <button class="btn" onclick="loadWebhooks()">üîî Webhooks Procesados</button>
      <button class="btn" onclick="loadTracking()">üìà Eventos de Tracking</button>
      <button class="btn" onclick="loadTemplates()">üìã Plantillas</button>
      <button class="btn" onclick="loadPreferences()">‚öôÔ∏è Preferencias</button>
      <button class="btn" onclick="loadConversations()">üí¨ Conversaciones</button>
      <button class="btn" onclick="loadStats()">üîÑ Actualizar</button>
    </div>

    <div id="contentSection"></div>
  </div>

  <script>
    const API_BASE = '/api/chatbot-api?type=monitor';
    let autoRefreshInterval = null;

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      setupAutoRefresh();
    });

    // Auto-refresh cada 60 segundos
    function setupAutoRefresh() {
      autoRefreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refresh: actualizando monitor...');
        loadStats();
      }, 60000);
    }

    // Cargar estad√≠sticas generales
    async function loadStats() {
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = '<div class="loading">Cargando estad√≠sticas...</div>';
      
      try {
        // Delay para dar tiempo a la conexi√≥n
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const response = await fetch(API_BASE);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.details || errorData.error || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        const { conversations, messages, tracking } = data.data;
        
        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-label">Conversaciones Totales</div>
            <div class="stat-value">${conversations.total}</div>
            <div class="stat-detail">
              ${conversations.active} activas ‚Ä¢ ${conversations.last24h} √∫ltimas 24h
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">üì®</div>
            <div class="stat-label">Mensajes (7 d√≠as)</div>
            <div class="stat-value">${messages.last7days}</div>
            <div class="stat-detail">
              Promedio ${conversations.avgMessages} por conversaci√≥n
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-label">Eventos Tracking (7 d√≠as)</div>
            <div class="stat-value">${tracking.last7days}</div>
            <div class="stat-detail">
              Webhooks adicionales procesados
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-label">Estado del Sistema</div>
            <div class="stat-value">‚úÖ</div>
            <div class="stat-detail">
              Neon PostgreSQL + OpenAI activos
            </div>
          </div>
        `;
        
        document.getElementById('contentSection').innerHTML = `
          <div class="timestamp">√öltima actualizaci√≥n: ${new Date(data.timestamp).toLocaleString('es-EC')}</div>
        `;
      } catch (error) {
        console.error('Error:', error);
        statsGrid.innerHTML = `
          <div class="stat-card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
            <div class="stat-icon" style="font-size: 48px;">‚ùå</div>
            <div class="stat-label">Error al cargar estad√≠sticas</div>
            <div class="stat-value" style="font-size: 16px; color: white;">${error.message}</div>
            <div class="stat-detail" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: left;">
              <strong>Posibles causas:</strong><br>
              ‚Ä¢ Base de datos no inicializada (ejecutar init script)<br>
              ‚Ä¢ Variable POSTGRES_URL no configurada en Vercel<br>
              ‚Ä¢ Tablas del chatbot no existen<br>
              ‚Ä¢ Error de conexi√≥n a Neon PostgreSQL<br><br>
              <strong>Soluci√≥n:</strong><br>
              1. Verifica POSTGRES_URL en Vercel<br>
              2. Inicializa las tablas enviando un mensaje de prueba al bot<br>
              3. Revisa logs de Vercel para detalles del error
            </div>
          </div>
        `;
      }
    }

    // Cargar webhooks procesados
    async function loadWebhooks() {
      const content = document.getElementById('contentSection');
      content.innerHTML = '<div class="section"><div class="loading">Cargando webhooks...</div></div>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch(`${API_BASE}&action=webhooks`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        let html = '<div class="section"><h2 class="section-title"><span>üîî</span> Webhooks Procesados (√∫ltimos 7 d√≠as)</h2>';
        
        if (data.webhooks.length === 0) {
          html += '<p style="color: #999;">No hay webhooks registrados a√∫n.</p>';
        } else {
          html += '<div class="table-container"><table>';
          html += '<thead><tr><th>Tipo de Webhook</th><th>Cantidad</th><th>√öltimo Evento</th></tr></thead><tbody>';
          
          data.webhooks.forEach(webhook => {
            html += `
              <tr>
                <td><span class="webhook-type">${webhook.type}</span></td>
                <td><strong>${webhook.count}</strong></td>
                <td>${new Date(webhook.lastEvent).toLocaleString('es-EC')}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
        }
        
        html += `<div class="timestamp">Actualizado: ${new Date(data.timestamp).toLocaleString('es-EC')}</div></div>`;
        content.innerHTML = html;
      } catch (error) {
        content.innerHTML = `<div class="section"><div class="error">Error: ${error.message}</div></div>`;
      }
    }

    // Cargar eventos de tracking
    async function loadTracking() {
      const content = document.getElementById('contentSection');
      content.innerHTML = '<div class="section"><div class="loading">Cargando eventos...</div></div>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch(`${API_BASE}&action=tracking&limit=50`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        let html = '<div class="section"><h2 class="section-title"><span>üìà</span> Eventos de Tracking Recientes</h2>';
        
        if (data.events.length === 0) {
          html += '<p style="color: #999;">No hay eventos de tracking registrados.</p>';
        } else {
          html += '<div class="table-container"><table>';
          html += '<thead><tr><th>ID</th><th>Tipo</th><th>Session ID</th><th>Timestamp</th><th>Datos</th></tr></thead><tbody>';
          
          data.events.forEach(event => {
            html += `
              <tr>
                <td>${event.id}</td>
                <td><span class="badge badge-info">${event.event_type}</span></td>
                <td><code>${event.session_id}</code></td>
                <td>${new Date(event.timestamp).toLocaleString('es-EC')}</td>
                <td><button class="btn" onclick="alert(JSON.stringify(${JSON.stringify(event.event_data)}, null, 2))">Ver JSON</button></td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
        }
        
        html += `<div class="timestamp">Actualizado: ${new Date(data.timestamp).toLocaleString('es-EC')}</div></div>`;
        content.innerHTML = html;
      } catch (error) {
        content.innerHTML = `<div class="section"><div class="error">Error: ${error.message}</div></div>`;
      }
    }

    // Cargar plantillas
    async function loadTemplates() {
      const content = document.getElementById('contentSection');
      content.innerHTML = '<div class="section"><div class="loading">Cargando plantillas...</div></div>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch(`${API_BASE}&action=templates`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        let html = '<div class="section"><h2 class="section-title"><span>üìã</span> Plantillas de WhatsApp</h2>';
        
        if (data.templates.length === 0) {
          html += '<p style="color: #999;">No hay plantillas configuradas a√∫n.</p>';
        } else {
          html += '<div class="table-container"><table>';
          html += '<thead><tr><th>Template ID</th><th>Categor√≠a</th><th>Estado</th><th>Actualizado</th></tr></thead><tbody>';
          
          data.templates.forEach(template => {
            html += `
              <tr>
                <td><code>${template.template_id}</code></td>
                <td>${template.category || 'N/A'}</td>
                <td><span class="badge badge-success">${template.status}</span></td>
                <td>${new Date(template.updated_at).toLocaleString('es-EC')}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
        }
        
        html += `<div class="timestamp">Actualizado: ${new Date(data.timestamp).toLocaleString('es-EC')}</div></div>`;
        content.innerHTML = html;
      } catch (error) {
        content.innerHTML = `<div class="section"><div class="error">Error: ${error.message}</div></div>`;
      }
    }

    // Cargar preferencias
    async function loadPreferences() {
      const content = document.getElementById('contentSection');
      content.innerHTML = '<div class="section"><div class="loading">Cargando preferencias...</div></div>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch(`${API_BASE}&action=preferences`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        let html = '<div class="section"><h2 class="section-title"><span>‚öôÔ∏è</span> Preferencias de Usuarios</h2>';
        html += `<p style="color: #666; margin-bottom: 20px;">${data.usersWithPreferences} usuarios con preferencias configuradas</p>`;
        
        if (data.preferences.length === 0) {
          html += '<p style="color: #999;">No hay preferencias configuradas a√∫n.</p>';
        } else {
          html += '<div class="table-container"><table>';
          html += '<thead><tr><th>Tel√©fono</th><th>Mensajes</th><th>Preferencias</th><th>√öltima Actividad</th></tr></thead><tbody>';
          
          data.preferences.forEach(pref => {
            const prefsJson = JSON.stringify(pref.preferences, null, 2);
            html += `
              <tr>
                <td>${pref.phone_number || 'N/A'}</td>
                <td><strong>${pref.total_messages}</strong></td>
                <td><button class="btn" onclick="alert(${JSON.stringify(prefsJson)})">Ver JSON</button></td>
                <td>${new Date(pref.last_message_at).toLocaleString('es-EC')}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
        }
        
        html += `<div class="timestamp">Actualizado: ${new Date(data.timestamp).toLocaleString('es-EC')}</div></div>`;
        content.innerHTML = html;
      } catch (error) {
        content.innerHTML = `<div class="section"><div class="error">Error: ${error.message}</div></div>`;
      }
    }

    // Cargar conversaciones
    async function loadConversations() {
      const content = document.getElementById('contentSection');
      content.innerHTML = '<div class="section"><div class="loading">Cargando conversaciones...</div></div>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch(`${API_BASE}&action=conversations&limit=50`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        let html = '<div class="section"><h2 class="section-title"><span>üí¨</span> Conversaciones Recientes (√∫ltimos 7 d√≠as)</h2>';
        
        if (data.conversations.length === 0) {
          html += '<p style="color: #999;">No hay conversaciones en los √∫ltimos 7 d√≠as.</p>';
        } else {
          html += '<div class="table-container"><table>';
          html += '<thead><tr><th>Tel√©fono</th><th>Estado</th><th>Mensajes</th><th>Creada</th><th>√öltima Actividad</th></tr></thead><tbody>';
          
          data.conversations.forEach(conv => {
            const badge = conv.is_active ? 'badge-success' : 'badge-warning';
            const status = conv.is_active ? 'Activa' : 'Inactiva';
            html += `
              <tr>
                <td>${conv.phone_number || 'N/A'}</td>
                <td><span class="badge ${badge}">${status}</span></td>
                <td><strong>${conv.message_count}</strong></td>
                <td>${new Date(conv.created_at).toLocaleString('es-EC')}</td>
                <td>${new Date(conv.last_message_at).toLocaleString('es-EC')}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
        }
        
        html += `<div class="timestamp">Actualizado: ${new Date(data.timestamp).toLocaleString('es-EC')}</div></div>`;
        content.innerHTML = html;
      } catch (error) {
        content.innerHTML = `<div class="section"><div class="error">Error: ${error.message}</div></div>`;
      }
    }

    // Cargar estad√≠sticas al iniciar
    window.addEventListener('DOMContentLoaded', loadStats);
  </script>
</body>
</html>
