<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Notificaciones - BIOSKIN</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status-box {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #deb887;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }

    .status-item:last-child {
      margin-bottom: 0;
    }

    .status-label {
      font-weight: 600;
      color: #555;
    }

    .status-value {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    .button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .button-secondary {
      background: #deb887;
      color: white;
    }

    .button-success {
      background: #28a745;
      color: white;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .log-box {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 5px;
      word-wrap: break-word;
    }

    .log-time {
      color: #888;
      margin-right: 10px;
    }

    .emoji {
      font-size: 24px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîî Test de Notificaciones</h1>
    <p class="subtitle">Sistema de diagn√≥stico para notificaciones del navegador</p>

    <div class="status-box">
      <div class="status-item">
        <span class="status-label">Soporte del Navegador</span>
        <span id="browserSupport" class="status-value">Verificando...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Estado de Permisos</span>
        <span id="permissionStatus" class="status-value">Verificando...</span>
      </div>
      <div class="status-item">
        <span class="status-label">√öltima Notificaci√≥n</span>
        <span id="lastNotification" class="status-value status-warning">Ninguna</span>
      </div>
    </div>

    <button id="requestPermissionBtn" class="button button-primary">
      üì¢ Solicitar Permisos de Notificaci√≥n
    </button>

    <button id="sendTestBtn" class="button button-secondary" disabled>
      üß™ Enviar Notificaci√≥n de Prueba
    </button>

    <button id="sendMultipleBtn" class="button button-success" disabled>
      üî• Enviar 3 Notificaciones (Test M√∫ltiple)
    </button>

    <div class="status-box" style="background: #fff3cd; border-left-color: #ffc107; margin-top: 20px;">
      <h3 style="margin-bottom: 15px; color: #856404; font-size: 16px;">üí° Gu√≠a para Chrome</h3>
      <div style="color: #856404; line-height: 1.6; font-size: 14px;">
        <p style="margin-bottom: 10px;"><strong>Si no aparece el di√°logo de permisos:</strong></p>
        <ol style="margin-left: 20px; margin-bottom: 15px;">
          <li>Haz clic en el <strong>candado üîí</strong> junto a la URL (arriba a la izquierda)</li>
          <li>Busca <strong>"Notificaciones"</strong></li>
          <li>Selecciona <strong>"Permitir"</strong></li>
          <li>Recarga esta p√°gina (F5)</li>
        </ol>
        <p style="margin-bottom: 10px;"><strong>O ve a configuraci√≥n avanzada:</strong></p>
        <p style="margin-left: 20px; font-family: monospace; background: white; padding: 5px; border-radius: 5px;">
          chrome://settings/content/notifications
        </p>
      </div>
    </div>

    <div class="log-box">
      <div class="log-entry"><span class="log-time">[INICIO]</span> Sistema de test iniciado...</div>
      <div id="logContainer"></div>
    </div>
  </div>

  <script>
    const logContainer = document.getElementById('logContainer');
    const browserSupportEl = document.getElementById('browserSupport');
    const permissionStatusEl = document.getElementById('permissionStatus');
    const lastNotificationEl = document.getElementById('lastNotification');
    const requestPermissionBtn = document.getElementById('requestPermissionBtn');
    const sendTestBtn = document.getElementById('sendTestBtn');
    const sendMultipleBtn = document.getElementById('sendMultipleBtn');

    let notificationCount = 0;

    function log(message, emoji = 'üìù') {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('es-ES');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${timeStr}]</span> ${emoji} ${message}`;
      logContainer.appendChild(entry);
      logContainer.parentElement.scrollTop = logContainer.parentElement.scrollHeight;
      console.log(`${emoji} ${message}`);
    }

    function updateStatus() {
      // Verificar soporte del navegador
      if ('Notification' in window) {
        browserSupportEl.textContent = '‚úÖ Soportado';
        browserSupportEl.className = 'status-value status-success';
        log('Navegador soporta notificaciones', '‚úÖ');
        
        // Informaci√≥n adicional del navegador
        const userAgent = navigator.userAgent;
        log(`Navegador detectado: ${userAgent.includes('Chrome') ? 'Chrome' : userAgent.includes('Firefox') ? 'Firefox' : userAgent.includes('Safari') ? 'Safari' : 'Otro'}`, 'üåê');
        
        // Verificar si es HTTPS o localhost
        const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
        log(`Protocolo seguro: ${isSecure ? '‚úÖ HTTPS' : '‚ö†Ô∏è HTTP (puede causar problemas)'}`, 'üîí');
        
      } else {
        browserSupportEl.textContent = '‚ùå No soportado';
        browserSupportEl.className = 'status-value status-error';
        log('Navegador NO soporta notificaciones', '‚ùå');
        return;
      }

      // Verificar permisos
      const permission = Notification.permission;
      log(`Estado de permisos actual: ${permission}`, 'üîç');

      switch (permission) {
        case 'granted':
          permissionStatusEl.textContent = '‚úÖ Otorgado';
          permissionStatusEl.className = 'status-value status-success';
          requestPermissionBtn.textContent = '‚úÖ Permisos Ya Otorgados';
          requestPermissionBtn.disabled = true;
          sendTestBtn.disabled = false;
          sendMultipleBtn.disabled = false;
          log('Permisos YA otorgados - puede enviar notificaciones', '‚úÖ');
          break;
        case 'denied':
          permissionStatusEl.textContent = '‚ùå Denegado';
          permissionStatusEl.className = 'status-value status-error';
          requestPermissionBtn.textContent = '‚ùå Permisos Bloqueados';
          requestPermissionBtn.disabled = true;
          log('Permisos DENEGADOS - debe habilitarlos en configuraci√≥n del navegador', '‚ùå');
          log('Para Chrome: Haz clic en el candado üîí junto a la URL ‚Üí Configuraci√≥n del sitio ‚Üí Notificaciones ‚Üí Permitir', 'üí°');
          break;
        case 'default':
          permissionStatusEl.textContent = '‚ö†Ô∏è Sin solicitar';
          permissionStatusEl.className = 'status-value status-warning';
          requestPermissionBtn.disabled = false;
          log('Permisos no solicitados - click en el bot√≥n para solicitar', '‚ö†Ô∏è');
          break;
      }
    }

    async function requestPermission() {
      log('Solicitando permisos al usuario...', 'üì¢');
      
      try {
        const permission = await Notification.requestPermission();
        log(`Resultado de solicitud: ${permission}`, 'üîî');
        
        if (permission === 'granted') {
          log('¬°Permisos OTORGADOS exitosamente!', 'üéâ');
          updateStatus();
          // Enviar notificaci√≥n de prueba autom√°ticamente
          setTimeout(() => sendTestNotification(), 500);
        } else if (permission === 'denied') {
          log('Permisos DENEGADOS por el usuario', 'üò¢');
          updateStatus();
        } else {
          log('Usuario cerr√≥ el di√°logo sin responder', '‚ö†Ô∏è');
          updateStatus();
        }
      } catch (error) {
        log(`ERROR al solicitar permisos: ${error.message}`, '‚ùå');
        console.error(error);
      }
    }

    function sendTestNotification() {
      if (Notification.permission !== 'granted') {
        log('No se puede enviar notificaci√≥n - permisos no otorgados', '‚ùå');
        alert('‚ö†Ô∏è Primero debes otorgar permisos de notificaci√≥n');
        return;
      }

      try {
        notificationCount++;
        const timestamp = new Date().toLocaleTimeString('es-ES');
        
        log(`Creando notificaci√≥n #${notificationCount}...`, 'üöÄ');
        
        const notification = new Notification('üß™ Notificaci√≥n de Prueba BIOSKIN', {
          body: `Esta es la notificaci√≥n #${notificationCount}\nHora: ${timestamp}\n\n‚ö†Ô∏è MIRA EL CENTRO DE NOTIFICACIONES DE WINDOWS (Win+N) SI NO VES UN POPUP`,
          icon: '/favicon.ico',
          badge: '/favicon.ico',
          tag: `bioskin-test-${Date.now()}`, // √önico para cada notificaci√≥n
          requireInteraction: true, // FORZAR que no se cierre autom√°ticamente
          silent: false, // Con sonido
          vibrate: [200, 100, 200] // Vibraci√≥n en dispositivos m√≥viles
        });

        log(`‚úÖ Notificaci√≥n #${notificationCount} ENVIADA exitosamente`, 'üéâ');
        log(`‚ö†Ô∏è Si no ves un popup, presiona Windows+N para ver el centro de notificaciones`, 'üí°');
        lastNotificationEl.textContent = `#${notificationCount} - ${timestamp}`;
        lastNotificationEl.className = 'status-value status-success';

        notification.onclick = () => {
          log(`Usuario hizo click en notificaci√≥n #${notificationCount}`, 'üëÜ');
          window.focus();
          notification.close();
        };

        notification.onerror = (error) => {
          log(`ERROR en notificaci√≥n #${notificationCount}: ${error}`, '‚ùå');
          log(`Posibles causas: Modo No Molestar de Windows activo, notificaciones de Chrome bloqueadas en Windows`, 'üîç');
        };

        notification.onshow = () => {
          log(`üëÅÔ∏è Notificaci√≥n #${notificationCount} mostrada en pantalla`, '‚úÖ');
          log(`Si no la ves como popup, puede estar en el centro de notificaciones de Windows`, 'üí°');
        };

        notification.onclose = () => {
          log(`Notificaci√≥n #${notificationCount} cerrada`, 'üîö');
        };

        // NO auto-cerrar para que permanezca visible
        // setTimeout(() => {
        //   notification.close();
        //   log(`Notificaci√≥n #${notificationCount} auto-cerrada`, '‚è∞');
        // }, 5000);

      } catch (error) {
        log(`ERROR al crear notificaci√≥n: ${error.message}`, '‚ùå');
        console.error(error);
      }
    }

    function sendMultipleNotifications() {
      log('Enviando 3 notificaciones con intervalos de 1 segundo...', 'üî•');
      
      sendTestNotification();
      
      setTimeout(() => {
        sendTestNotification();
      }, 1000);
      
      setTimeout(() => {
        sendTestNotification();
      }, 2000);
    }

    // Event listeners
    requestPermissionBtn.addEventListener('click', requestPermission);
    sendTestBtn.addEventListener('click', sendTestNotification);
    sendMultipleBtn.addEventListener('click', sendMultipleNotifications);

    // Inicializar
    updateStatus();
    log('Sistema listo para probar notificaciones', '‚úÖ');
  </script>
</body>
</html>
