<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Blog Flow - BIOSKIN</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test de Flujo de Blogs - BIOSKIN</h1>
    
    <div class="test-section">
        <h2>üìã Panel de Control</h2>
        <button onclick="testAllEndpoints()">üîç Probar Todos los Endpoints</button>
        <button onclick="generateTestBlog()">ü§ñ Generar Blog de Prueba</button>
        <button onclick="checkPublicBlogs()">üëÄ Verificar Blogs P√∫blicos</button>
        <button onclick="clearLog()">üßπ Limpiar Log</button>
    </div>

    <div id="log-container">
        <h2>üìù Log de Pruebas</h2>
        <div id="log"></div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        let testBlogSlug = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            logEl.innerHTML += `
                <div class="test-section ${className}">
                    <strong>[${timestamp}]</strong> ${message}
                </div>
            `;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testAllEndpoints() {
            log('üîç Iniciando pruebas de endpoints...', 'info');
            
            const endpoints = [
                '/api/blogs/manage',
                '/api/blogs/static', 
                '/api/ai-blog/generate-production'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`Probando ${endpoint}...`);
                    const response = await fetch(baseUrl + endpoint);
                    const data = await response.json();
                    
                    if (data.success !== false) {
                        log(`‚úÖ ${endpoint} - OK (${response.status})`, 'success');
                        if (endpoint === '/api/blogs/manage' && data.blogs) {
                            log(`üìä Encontrados ${data.blogs.length} blogs`, 'info');
                        }
                    } else {
                        log(`‚ö†Ô∏è ${endpoint} - ${data.message}`, 'warning');
                    }
                } catch (error) {
                    log(`‚ùå ${endpoint} - Error: ${error.message}`, 'error');
                }
            }
        }

        async function generateTestBlog() {
            log('ü§ñ Generando blog de prueba...', 'info');
            
            const blogRequest = {
                blogType: 'medico-estetico',
                topic: 'Prueba automatizada - Beneficios del col√°geno en medicina est√©tica',
                manual: true
            };

            try {
                const response = await fetch(baseUrl + '/api/ai-blog/generate-production', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(blogRequest)
                });

                const result = await response.json();
                
                if (result.success) {
                    testBlogSlug = result.blog.slug;
                    log(`‚úÖ Blog generado exitosamente!`, 'success');
                    log(`üìù T√≠tulo: ${result.blog.title}`, 'info');
                    log(`üîó Slug: ${result.blog.slug}`, 'info');
                    log(`üíæ Guardado: ${result.meta?.saveMethod || 'unknown'}`, 'info');
                    
                    // Verificar inmediatamente si aparece en la lista
                    setTimeout(() => checkBlogInList(testBlogSlug), 1000);
                } else {
                    log(`‚ùå Error generando blog: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error en generaci√≥n: ${error.message}`, 'error');
            }
        }

        async function checkBlogInList(slug) {
            log(`üîç Verificando si el blog aparece en la lista...`, 'info');
            
            try {
                const response = await fetch(baseUrl + '/api/blogs/manage');
                const data = await response.json();
                
                if (data.success && data.blogs) {
                    const foundBlog = data.blogs.find(b => b.slug === slug);
                    
                    if (foundBlog) {
                        log(`‚úÖ ¬°Blog encontrado en la lista!`, 'success');
                        log(`üìñ T√≠tulo: ${foundBlog.title}`, 'success');
                        log(`üìç Fuente: ${foundBlog.source}`, 'info');
                    } else {
                        log(`‚ùå Blog NO encontrado en la lista`, 'error');
                        log(`üîç Blogs disponibles: ${data.blogs.map(b => b.title.substring(0, 30)).join(', ')}`, 'warning');
                    }
                } else {
                    log(`‚ùå Error obteniendo lista de blogs`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error verificando lista: ${error.message}`, 'error');
            }
        }

        async function checkPublicBlogs() {
            log('üëÄ Verificando blogs en p√°gina p√∫blica...', 'info');
            
            try {
                // Probar m√∫ltiples endpoints
                const endpoints = [
                    '/api/blogs/manage',
                    '/api/blogs/static',
                    '/api/blogs'
                ];

                for (const endpoint of endpoints) {
                    try {
                        log(`Probando endpoint: ${endpoint}`);
                        const response = await fetch(baseUrl + endpoint);
                        const data = await response.json();
                        
                        if (data.success && data.blogs) {
                            log(`‚úÖ ${endpoint}: ${data.blogs.length} blogs`, 'success');
                            
                            // Mostrar algunos blogs
                            data.blogs.slice(0, 3).forEach(blog => {
                                log(`  üìÑ ${blog.title} (${blog.category}) [${blog.source || 'unknown'}]`, 'info');
                            });
                        } else {
                            log(`‚ö†Ô∏è ${endpoint}: ${data.message || 'Sin datos'}`, 'warning');
                        }
                    } catch (error) {
                        log(`‚ùå ${endpoint}: ${error.message}`, 'error');
                    }
                }

                // Verificar si el blog de prueba existe
                if (testBlogSlug) {
                    checkBlogInList(testBlogSlug);
                }
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }

        // Ejecutar prueba inicial al cargar la p√°gina
        window.onload = function() {
            log('üöÄ P√°gina de pruebas cargada. Lista para testing.', 'info');
            testAllEndpoints();
        };
    </script>
</body>
</html>