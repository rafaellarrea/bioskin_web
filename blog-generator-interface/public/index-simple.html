<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIOSKIN - Generador de Blogs con IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            color: white;
        }

        .btn-primary { background: #3498db; }
        .btn-success { background: #27ae60; }
        .btn-warning { background: #f39c12; }
        .btn-info { background: #17a2b8; }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin: 10px 0;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid #27ae60;
            color: #27ae60;
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .blog-preview {
            display: none;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 2rem;
            background: #f8f9fa;
        }

        .blog-preview.active {
            display: block;
        }

        .blog-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .blog-content {
            line-height: 1.8;
            color: #333;
        }

        .blog-content h1, .blog-content h2, .blog-content h3 {
            margin: 1.5rem 0 1rem;
            color: #2c3e50;
        }

        .blog-content p {
            margin-bottom: 1rem;
        }

        .tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }

        /* ‚úÖ NUEVOS ESTILOS PARA EDICI√ìN */
        .edit-section {
            display: none;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 2rem;
            background: #fefefe;
            margin-top: 2rem;
        }

        .tab-container {
            margin-bottom: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #f39c12;
            border-bottom-color: #f39c12;
        }

        .tab-btn:hover {
            color: #f39c12;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
            padding-top: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            color: #2c3e50;
            margin: 1.5rem 0 0.5rem;
            font-size: 1.2rem;
        }

        .tab-content h3:first-child {
            margin-top: 0;
        }

        .upload-zone {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-zone:hover {
            border-color: #f39c12;
            background: #fff3cd;
        }

        .upload-zone i {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .upload-zone p {
            margin: 0.5rem 0;
            color: #6c757d;
        }

        .upload-zone .small {
            font-size: 0.8rem;
            color: #999;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 1rem 0;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.2);
        }

        .action-buttons {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .current-image {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        #imagePreview {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        #imagePreview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        #imageUpload {
            display: none;
        }

        /* ‚úÖ ESTILOS PARA SUGERENCIAS DE TEMAS */
        .suggestions-container {
            display: grid;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .suggestion-item {
            padding: 0.8rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .suggestion-item:hover {
            background: #e67e22;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(230, 126, 34, 0.3);
        }

        .suggestion-text {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .suggestion-use {
            padding: 4px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .suggestion-item:hover .suggestion-use {
            opacity: 1;
        }

        .suggestions-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .suggestions-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1><i class="fas fa-brain"></i> BIOSKIN - Generador de Blogs con IA</h1>
            <p>Sistema Simplificado para Generar Contenido M√©dico Est√©tico</p>
        </div>

        <div class="card">
            <h2><i class="fas fa-cog"></i> Configuraci√≥n del Blog</h2>
            
            <label>Categor√≠a del Blog:</label>
            <select id="category" class="form-control">
                <option value="">Selecciona una categor√≠a</option>
                <option value="medico-estetico">M√©dico Est√©tico</option>
                <option value="tecnico">T√©cnico/Equipos</option>
            </select>

            <label>Tema Personalizado (Opcional):</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                <input type="text" id="customTopic" class="form-control" 
                       placeholder="Ej: Tratamiento de arrugas con toxina botul√≠nica" style="flex: 1;">
                <button class="btn" onclick="suggestTopics()" id="suggestBtn" 
                        style="background: #e67e22; color: white; white-space: nowrap;">
                    <i class="fas fa-lightbulb"></i> Sugerir Temas
                </button>
            </div>
            
            <!-- ‚úÖ NUEVA SECCI√ìN: Sugerencias de temas -->
            <div id="suggestionsSection" style="display: none; margin-top: 1rem;">
                <label><i class="fas fa-magic"></i> Temas Sugeridos por IA:</label>
                <div id="suggestionsList" class="suggestions-container">
                    <!-- Las sugerencias se cargar√°n aqu√≠ -->
                </div>
            </div>

            <button class="btn btn-primary" onclick="testConnection()">
                <i class="fas fa-network-wired"></i> Test Conexi√≥n
            </button>

            <button class="btn" style="background: #9b59b6; color: white;" onclick="diagnoseVercel()">
                <i class="fas fa-stethoscope"></i> Diagnosticar APIs Vercel
            </button>

            <button class="btn btn-warning" onclick="generateBlogMock()">
                <i class="fas fa-vial"></i> Generar Blog de Prueba
            </button>
            
            <button class="btn btn-primary" onclick="generateBlog()">
                <i class="fas fa-magic"></i> Generar Blog con IA
            </button>

            <!-- Loading State -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Generando contenido con IA...</p>
            </div>
        </div>

        <!-- Vista Previa del Blog -->
        <div id="blogPreview" class="card blog-preview">
            <h2><i class="fas fa-eye"></i> Vista Previa del Blog</h2>
            
            <div id="previewContent">
                <!-- El contenido se cargar√° aqu√≠ -->
            </div>

            <button class="btn btn-success" onclick="saveBlog()" id="saveBtn" disabled>
                <i class="fas fa-save"></i> Guardar y Desplegar Blog
            </button>
        </div>

        <!-- ‚úÖ NUEVA SECCI√ìN: Editar Blog -->
        <div id="editSection" class="card edit-section" style="display: none;">
            <h2><i class="fas fa-edit"></i> Revisar y Editar Blog</h2>
            
            <!-- Tabs para diferentes secciones de edici√≥n -->
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('content')">
                        <i class="fas fa-file-text"></i> Contenido
                    </button>
                    <button class="tab-btn" onclick="switchTab('image')">
                        <i class="fas fa-image"></i> Imagen
                    </button>
                    <button class="tab-btn" onclick="switchTab('metadata')">
                        <i class="fas fa-tags"></i> Metadatos
                    </button>
                </div>
            </div>

            <!-- Tab: Editar Contenido -->
            <div id="contentTab" class="tab-content active">
                <h3>Editar T√≠tulo</h3>
                <input type="text" id="editTitle" class="form-control" placeholder="T√≠tulo del blog">
                
                <h3>Editar Extracto</h3>
                <textarea id="editExcerpt" class="form-control" rows="3" placeholder="Extracto del blog"></textarea>
                
                <h3>Editar Contenido</h3>
                <textarea id="editContent" class="form-control" rows="15" placeholder="Contenido completo del blog"></textarea>
                
                <button class="btn btn-primary" onclick="previewChanges()">
                    <i class="fas fa-eye"></i> Vista Previa Cambios
                </button>
            </div>

            <!-- Tab: A√±adir Imagen -->
            <div id="imageTab" class="tab-content">
                <h3>Imagen Principal del Blog</h3>
                
                <div class="image-upload-area">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <div class="upload-zone" onclick="document.getElementById('imageUpload').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Haz clic para subir una imagen</p>
                        <p class="small">JPG, PNG, WebP (m√°x. 5MB)</p>
                    </div>
                </div>

                <div id="imagePreview" style="display: none;">
                    <h4>Vista Previa:</h4>
                    <img id="previewImg" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <button class="btn btn-danger" onclick="removeImage()">
                        <i class="fas fa-trash"></i> Quitar Imagen
                    </button>
                </div>

                <div class="current-image" id="currentImage">
                    <h4>Imagen Actual:</h4>
                    <p>No hay imagen asignada</p>
                </div>
            </div>

            <!-- Tab: Editar Metadatos -->
            <div id="metadataTab" class="tab-content">
                <h3>Categor√≠a</h3>
                <select id="editCategory" class="form-control">
                    <option value="medico-estetico">M√©dico Est√©tico</option>
                    <option value="tecnico">T√©cnico</option>
                    <option value="general">General</option>
                </select>

                <h3>Tags</h3>
                <input type="text" id="editTags" class="form-control" placeholder="Separados por comas: tag1, tag2, tag3">
                
                <h3>Autor</h3>
                <input type="text" id="editAuthor" class="form-control" placeholder="Autor del blog">

                <h3>¬øArt√≠culo Destacado?</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="editFeatured">
                    <span class="checkmark"></span>
                    Marcar como art√≠culo destacado
                </label>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="resetChanges()">
                    <i class="fas fa-undo"></i> Descartar Cambios
                </button>
                <button class="btn btn-info" onclick="switchTab('image'); document.getElementById('imageUpload').click();">
                    <i class="fas fa-image"></i> Cargar Imagen
                </button>
                <button class="btn btn-primary" onclick="applyChanges()">
                    <i class="fas fa-check"></i> Aplicar Cambios
                </button>
                <button class="btn btn-success" onclick="saveBlogWithEdits()" id="saveFinalBtn">
                    <i class="fas fa-save"></i> Guardar & Desplegar
                </button>
            </div>
        </div>

        <!-- √Årea de mensajes temporales (para compatibilidad) -->
        <div id="messages"></div>
        
        <!-- ‚úÖ NUEVO: √Årea de logs permanente -->
        <div class="logs-section" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3><i class="fas fa-list"></i> Registro de Actividad</h3>
                <div>
                    <button class="btn btn-secondary" onclick="clearLogs()" style="margin-right: 1rem;">
                        <i class="fas fa-trash"></i> Limpiar Logs
                    </button>
                    <button class="btn btn-primary" onclick="refreshPage()">
                        <i class="fas fa-sync-alt"></i> Refrescar P√°gina
                    </button>
                </div>
            </div>
            <textarea id="logsBox" class="form-control" rows="10" readonly 
                style="background: #f8f9fa; font-family: 'Courier New', monospace; font-size: 12px;">
Sistema iniciado - Listo para generar blogs...
            </textarea>
        </div>
    </div>

    <script>
        console.log('üöÄ Iniciando aplicaci√≥n...');
        
        let currentBlog = null;

        // ‚úÖ NUEVA: Funci√≥n para agregar logs permanentes
        function addLog(message, type = 'info') {
            console.log(`üì¢ Log: ${message} (${type})`);
            
            const logsBox = document.getElementById('logsBox');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const logEntry = `[${timestamp}] ${icon} ${message}\n`;
            logsBox.value += logEntry;
            
            // Auto-scroll to bottom
            logsBox.scrollTop = logsBox.scrollHeight;
        }

        // ‚úÖ Funci√≥n para mostrar alertas (mantener compatibilidad + agregar a logs)
        function showAlert(message, type = 'success') {
            // Agregar al sistema de logs permanente
            addLog(message, type);
            
            // Mantener alerta temporal para feedback inmediato
            const messagesDiv = document.getElementById('messages');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            
            messagesDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000); // Reducido a 3 segundos
        }

        // ‚úÖ NUEVA: Funci√≥n para limpiar logs
        function clearLogs() {
            const logsBox = document.getElementById('logsBox');
            logsBox.value = 'Sistema reiniciado - Logs limpiados...\n';
            addLog('Logs limpiados por el usuario');
        }

        // ‚úÖ NUEVA: Funci√≥n para refrescar p√°gina manualmente
        function refreshPage() {
            addLog('Refrescando p√°gina por solicitud del usuario...');
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        // Funci√≥n de prueba de conexi√≥n
        async function testConnection() {
            console.log('üß™ BOT√ìN TEST CONEXI√ìN CLICKEADO');
            showAlert('Probando conexi√≥n...', 'success');
            
            try {
                const response = await fetch('/api/test');
                const result = await response.json();
                console.log('‚úÖ Test exitoso:', result);
                showAlert(`Conexi√≥n OK: ${result.message}`, 'success');
            } catch (error) {
                console.error('‚ùå Error:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para generar blog de prueba (local)
        async function generateBlogMock() {
            console.log('üé≠ BOT√ìN GENERAR BLOG DE PRUEBA CLICKEADO');
            
            const category = document.getElementById('category').value;
            const customTopic = document.getElementById('customTopic').value.trim();

            if (!category) {
                showAlert('Por favor selecciona una categor√≠a', 'error');
                return;
            }

            console.log('üìù Categor√≠a:', category);
            console.log('üéØ Tema:', customTopic);

            const loading = document.getElementById('loading');
            const generateBtn = event.target;

            generateBtn.disabled = true;
            loading.classList.add('active');
            showAlert('Generando blog de prueba...', 'success');

            try {
                const response = await fetch('/api/generate-blog-mock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category,
                        customTopic: customTopic || undefined
                    })
                });

                console.log('üì• Respuesta:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Resultado:', result);

                if (result.success && result.blog) {
                    currentBlog = result.blog;
                    displayBlogPreview(result.blog);
                    showAlert('Blog de prueba generado exitosamente', 'success');
                } else {
                    throw new Error(result.error || 'Error generando blog de prueba');
                }

            } catch (error) {
                console.error('‚ùå Error generando blog de prueba:', error);
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        // Funci√≥n para generar blog con IA real
        async function generateBlog() {
            console.log('üöÄ BOT√ìN GENERAR BLOG CON IA CLICKEADO');
            addLog('üöÄ Iniciando generaci√≥n de blog con IA...');
            
            const category = document.getElementById('category').value;
            const customTopic = document.getElementById('customTopic').value.trim();

            if (!category) {
                showAlert('Por favor selecciona una categor√≠a', 'error');
                return;
            }

            addLog(`üìù Categor√≠a seleccionada: ${category}`);
            addLog(`üéØ Tema: ${customTopic || 'Tema generado autom√°ticamente'}`);
            
            console.log('üìù Categor√≠a:', category);
            console.log('üéØ Tema:', customTopic);

            const loading = document.getElementById('loading');
            const generateBtn = event.target;

            generateBtn.disabled = true;
            loading.classList.add('active');
            addLog('‚è≥ Conectando con IA de OpenAI...');
            addLog('ü§ñ Generando contenido - esto puede tomar 30-60 segundos');
            showAlert('Generando blog con IA (esto puede tomar 30-60 segundos)...', 'success');

            try {
                const response = await fetch('/api/generate-blog', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category,
                        customTopic: customTopic || undefined
                    })
                });

                console.log('üì• Respuesta:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error del servidor:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Resultado:', result);

                if (result.success && result.blog) {
                    currentBlog = result.blog;
                    addLog(`‚úÖ Blog generado exitosamente: "${result.blog.title}"`);
                    addLog(`üìÑ Palabras: ${result.meta?.wordCount || 'N/A'} | Tiempo de lectura: ${result.blog.readTime}min`);
                    addLog('üìù Blog listo para edici√≥n y guardado');
                    displayBlogPreview(result.blog);
                    showAlert('Blog generado exitosamente con IA', 'success');
                } else {
                    throw new Error(result.error || 'Error generando blog con IA');
                }

            } catch (error) {
                console.error('‚ùå Error generando blog con IA:', error);
                showAlert(`Error con IA: ${error.message}. Prueba el bot√≥n de "Blog de Prueba" para verificar el sistema.`, 'error');
            } finally {
                generateBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Limpiar contenido Markdown para el editor
        function cleanMarkdownForEditor(content) {
            if (!content) return '';
            
            return content
                // Convertir headers # a texto plano con formato
                .replace(/#{1}\s*(.*)/g, '$1\n' + '='.repeat(50))
                .replace(/#{2}\s*(.*)/g, '\n$1\n' + '-'.repeat(30))
                .replace(/#{3}\s*(.*)/g, '\n$1\n')
                // Limpiar negritas pero mantener √©nfasis
                .replace(/\*\*(.*?)\*\*/g, '>>> $1 <<<')
                // Limpiar cursivas
                .replace(/\*(.*?)\*/g, '$1')
                // Mejorar espaciado
                .replace(/\n\n/g, '\n\n')
                .trim();
        }

        // ‚úÖ NUEVA FUNCI√ìN: Convertir contenido del editor de vuelta a Markdown
        function convertEditorToMarkdown(content) {
            if (!content) return '';
            
            return content
                // Convertir t√≠tulos con = de vuelta a #
                .replace(/^(.*)\n={50}$/gm, '# $1')
                .replace(/^(.*)\n-{30}$/gm, '## $1')
                // Convertir √©nfasis de vuelta a negritas
                .replace(/>>> (.*?) <<</g, '**$1**')
                // Asegurar espaciado adecuado
                .replace(/\n\n\n+/g, '\n\n')
                .trim();
        }

        // Funci√≥n para mostrar vista previa
        function displayBlogPreview(blog) {
            console.log('üëÄ Mostrando vista previa del blog');
            
            const previewContainer = document.getElementById('blogPreview');
            const contentContainer = document.getElementById('previewContent');

            // Convertir markdown b√°sico a HTML
            const htmlContent = blog.content
                .replace(/#{3}\s(.*)/g, '<h3>$1</h3>')
                .replace(/#{2}\s(.*)/g, '<h2>$1</h2>')
                .replace(/#{1}\s(.*)/g, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.)/g, '<p>$1')
                .replace(/(.)$/g, '$1</p>');

            contentContainer.innerHTML = `
                <div class="blog-title">${blog.title}</div>
                <div style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
                    <span><i class="fas fa-calendar"></i> ${blog.published_at}</span> |
                    <span><i class="fas fa-clock"></i> ${blog.readTime} min lectura</span> |
                    <span><i class="fas fa-tag"></i> ${blog.category}</span>
                </div>
                <div class="blog-content">
                    ${htmlContent}
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Excerpt:</strong>
                    <p style="font-style: italic; color: #666;">${blog.excerpt}</p>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Tags:</strong>
                    ${blog.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
            `;

            previewContainer.classList.add('active');
            
            // ‚úÖ NUEVO: Mostrar botones de edici√≥n y cargar datos
            document.getElementById('editSection').style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Cargar datos para edici√≥n
            loadBlogForEditing();
        }

        // Funci√≥n para guardar blog
        async function saveBlog() {
            console.log('üíæ BOT√ìN GUARDAR CLICKEADO');
            
            if (!currentBlog) {
                showAlert('No hay blog para guardar', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            showAlert('Guardando y desplegando blog...', 'success');

            try {
                const response = await fetch('/api/save-and-deploy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        blogData: currentBlog,
                        images: [] // Por ahora sin im√°genes
                    })
                });

                const result = await response.json();
                console.log('‚úÖ Guardado:', result);

                if (result.success) {
                    showAlert(`Blog "${currentBlog.title}" guardado y desplegado exitosamente`, 'success');
                    
                    // Reset despu√©s de 3 segundos
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Error guardando blog');
                }

            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showAlert(`Error guardando: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar y Desplegar Blog';
            }
        }

        // Funci√≥n para diagnosticar Vercel APIs
        async function diagnoseVercel() {
            console.log('üîç DIAGN√ìSTICO DE VERCEL INICIADO');
            showAlert('Diagnosticando conexi√≥n con Vercel...', 'success');
            
            try {
                const response = await fetch('/api/diagnose-vercel', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                console.log('üìä Resultado del diagn√≥stico:', result);

                if (result.success) {
                    showAlert('Diagn√≥stico completado. Ver consola para detalles.', 'success');
                    console.log('‚úÖ URLs funcionales:', result.workingUrls);
                    console.log('‚ùå URLs con errores:', result.errorUrls);
                } else {
                    throw new Error(result.error || 'Error en diagn√≥stico');
                }

            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
                showAlert(`Error en diagn√≥stico: ${error.message}`, 'error');
            }
        }

        // ‚úÖ NUEVAS FUNCIONES PARA EDICI√ìN DE BLOGS

        // Funci√≥n para cambiar entre tabs
        function switchTab(tabName) {
            console.log(`üîÑ Cambiando a tab: ${tabName}`);
            
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el tab seleccionado
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        // Funci√≥n para cargar datos del blog en los campos de edici√≥n
        function loadBlogForEditing() {
            if (!currentBlog) return;
            
            console.log('üìù Cargando blog para edici√≥n');
            
            // Cargar datos b√°sicos
            document.getElementById('editTitle').value = currentBlog.title || '';
            document.getElementById('editExcerpt').value = currentBlog.excerpt || '';
            // ‚úÖ Limpiar contenido Markdown para mejor visualizaci√≥n en editor
            document.getElementById('editContent').value = cleanMarkdownForEditor(currentBlog.content) || '';
            document.getElementById('editCategory').value = currentBlog.category || 'medico-estetico';
            document.getElementById('editAuthor').value = currentBlog.author || 'BIOSKIN IA';
            document.getElementById('editFeatured').checked = currentBlog.featured || false;
            
            // Cargar tags
            if (currentBlog.tags && Array.isArray(currentBlog.tags)) {
                document.getElementById('editTags').value = currentBlog.tags.join(', ');
            }
            
            // Mostrar imagen actual si existe
            updateCurrentImageDisplay();
        }

        // Funci√≥n para actualizar la vista de imagen actual
        function updateCurrentImageDisplay() {
            const currentImageDiv = document.getElementById('currentImage');
            const hasImage = currentBlog.image && currentBlog.image !== '/images/logo/logo-bioskin.png';
            
            if (hasImage) {
                currentImageDiv.innerHTML = `
                    <h4>Imagen Actual:</h4>
                    <img src="${currentBlog.image}" style="max-width: 200px; height: auto; border-radius: 8px;">
                    <p>${currentBlog.image}</p>
                `;
            } else {
                currentImageDiv.innerHTML = `
                    <h4>Imagen Actual:</h4>
                    <p>No hay imagen asignada (se usar√° logo BIOSKIN por defecto)</p>
                `;
            }
        }

        // Funci√≥n para manejar subida de imagen
        function handleImageUpload(event) {
            console.log('üì∏ Procesando subida de imagen');
            
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tipo de archivo
            if (!file.type.match(/^image\/(jpeg|jpg|png|webp)$/)) {
                showAlert('Por favor selecciona una imagen v√°lida (JPG, PNG, WebP)', 'error');
                return;
            }
            
            // Validar tama√±o (5MB m√°x)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('La imagen es muy grande. M√°ximo 5MB', 'error');
                return;
            }
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
                
                showAlert('Imagen cargada. Recuerda aplicar cambios', 'success');
            };
            
            reader.readAsDataURL(file);
        }

        // Funci√≥n para quitar imagen
        function removeImage() {
            console.log('üóëÔ∏è Quitando imagen');
            
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            showAlert('Imagen removida', 'success');
        }

        // Funci√≥n para vista previa de cambios
        function previewChanges() {
            console.log('üëÄ Generando vista previa de cambios');
            
            if (!currentBlog) {
                showAlert('No hay blog para previsualizar', 'error');
                return;
            }
            
            // Crear blog temporal con los cambios
            const tempBlog = {
                ...currentBlog,
                title: document.getElementById('editTitle').value || currentBlog.title,
                excerpt: document.getElementById('editExcerpt').value || currentBlog.excerpt,
                content: document.getElementById('editContent').value || currentBlog.content,
                category: document.getElementById('editCategory').value || currentBlog.category,
                author: document.getElementById('editAuthor').value || currentBlog.author,
                featured: document.getElementById('editFeatured').checked
            };
            
            // Actualizar tags
            const tagsInput = document.getElementById('editTags').value;
            if (tagsInput.trim()) {
                tempBlog.tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            }
            
            // Mostrar vista previa actualizada
            displayBlogPreview(tempBlog);
            showAlert('Vista previa actualizada con tus cambios', 'success');
        }

        // Funci√≥n para aplicar cambios
        function applyChanges() {
            console.log('‚úÖ Aplicando cambios al blog');
            
            if (!currentBlog) {
                showAlert('No hay blog para editar', 'error');
                return;
            }
            
            // Aplicar cambios al blog actual
            currentBlog.title = document.getElementById('editTitle').value || currentBlog.title;
            currentBlog.excerpt = document.getElementById('editExcerpt').value || currentBlog.excerpt;
            // ‚úÖ Convertir contenido del editor de vuelta a Markdown
            currentBlog.content = convertEditorToMarkdown(document.getElementById('editContent').value) || currentBlog.content;
            currentBlog.category = document.getElementById('editCategory').value || currentBlog.category;
            currentBlog.author = document.getElementById('editAuthor').value || currentBlog.author;
            currentBlog.featured = document.getElementById('editFeatured').checked;
            
            // Actualizar tags
            const tagsInput = document.getElementById('editTags').value;
            if (tagsInput.trim()) {
                currentBlog.tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            }
            
            // Regenerar slug si cambi√≥ el t√≠tulo
            if (currentBlog.title !== currentBlog.originalTitle) {
                currentBlog.slug = currentBlog.title.toLowerCase()
                    .replace(/[√°√†√§√¢]/g, 'a')
                    .replace(/[√©√®√´√™]/g, 'e')
                    .replace(/[√≠√¨√Ø√Æ]/g, 'i')
                    .replace(/[√≥√≤√∂√¥]/g, 'o')
                    .replace(/[√∫√π√º√ª]/g, 'u')
                    .replace(/√±/g, 'n')
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/--+/g, '-')
                    .trim('-') + '-' + Date.now();
            }
            
            // Marcar como editado
            currentBlog.edited = true;
            currentBlog.editedAt = new Date().toISOString();
            
            // Actualizar vista previa
            displayBlogPreview(currentBlog);
            
            showAlert('Cambios aplicados exitosamente', 'success');
        }

        // Funci√≥n para descartar cambios
        function resetChanges() {
            console.log('üîÑ Descartando cambios');
            
            if (!currentBlog) return;
            
            // Recargar datos originales
            loadBlogForEditing();
            
            // Limpiar imagen
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            showAlert('Cambios descartados', 'success');
        }

        // Funci√≥n mejorada para guardar blog con ediciones
        async function saveBlogWithEdits() {
            console.log('üíæ GUARDANDO BLOG CON EDICIONES');
            
            if (!currentBlog) {
                showAlert('No hay blog para guardar', 'error');
                return;
            }
            
            const saveFinalBtn = document.getElementById('saveFinalBtn');
            saveFinalBtn.disabled = true;
            saveFinalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                // ‚úÖ Aplicar cambios autom√°ticamente antes de guardar
                applyChanges();
                
                // Manejar subida de imagen si hay una nueva
                let imageData = [];
                const imageFile = document.getElementById('imageUpload').files[0];
                
                if (imageFile) {
                    console.log('üì§ Subiendo imagen nueva');
                    showAlert('Subiendo imagen...', 'success');
                    
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    formData.append('blogSlug', currentBlog.slug);
                    
                    const imageResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const imageResult = await imageResponse.json();
                    
                    if (imageResult.success) {
                        currentBlog.image = imageResult.imageUrl;
                        currentBlog.imagenPrincipal = imageResult.imageUrl;
                        imageData = [imageResult];
                        showAlert('Imagen subida exitosamente', 'success');
                    } else {
                        throw new Error(imageResult.error || 'Error subiendo imagen');
                    }
                }
                
                showAlert('Guardando blog final...', 'success');
                
                // Guardar blog completo
                const response = await fetch('/api/save-and-deploy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        blogData: currentBlog,
                        images: imageData
                    })
                });
                
                const result = await response.json();
                console.log('‚úÖ Blog guardado:', result);
                
                if (result.success) {
                    showAlert(`Blog "${currentBlog.title}" guardado y desplegado exitosamente`, 'success');
                    addLog('‚ú® Blog guardado correctamente - Listo para crear otro blog');
                    addLog('üí° Tip: Usa el bot√≥n "Refrescar P√°gina" si necesitas empezar de nuevo');
                    
                    // ‚úÖ NO auto-refresh - El usuario decide cu√°ndo refrescar
                } else {
                    throw new Error(result.error || 'Error guardando blog');
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando blog final:', error);
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                saveFinalBtn.disabled = false;
                saveFinalBtn.innerHTML = '<i class="fas fa-save"></i> Guardar & Desplegar';
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Sugerir temas con IA
        async function suggestTopics() {
            console.log('üí° INICIANDO SUGERENCIA DE TEMAS CON IA');
            
            const category = document.getElementById('category').value;
            
            if (!category) {
                showAlert('Por favor selecciona una categor√≠a primero', 'error');
                return;
            }
            
            const suggestBtn = document.getElementById('suggestBtn');
            const suggestionsSection = document.getElementById('suggestionsSection');
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Mostrar loading
            suggestBtn.disabled = true;
            suggestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            
            suggestionsSection.style.display = 'block';
            suggestionsList.innerHTML = `
                <div class="suggestions-loading">
                    <i class="fas fa-magic"></i>
                    <p>Generando sugerencias personalizadas con IA...</p>
                    <small>Basado en categor√≠a: <strong>${category === 'medico-estetico' ? 'M√©dico Est√©tico' : 'T√©cnico'}</strong></small>
                </div>
            `;
            
            showAlert('Generando sugerencias de temas con IA...', 'success');
            
            try {
                const response = await fetch('/api/suggest-topics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category
                    })
                });

                const result = await response.json();
                console.log('üìã Sugerencias recibidas:', result);

                if (result.success && result.suggestions && result.suggestions.length > 0) {
                    displaySuggestions(result.suggestions, result.source);
                    showAlert(`${result.suggestions.length} temas sugeridos generados`, 'success');
                } else {
                    throw new Error(result.error || 'No se pudieron generar sugerencias');
                }

            } catch (error) {
                console.error('‚ùå Error generando sugerencias:', error);
                showAlert(`Error: ${error.message}`, 'error');
                
                // Mostrar mensaje de error en la secci√≥n
                suggestionsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error generando sugerencias: ${error.message}</p>
                        <button class="btn btn-secondary" onclick="suggestTopics()">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
                
            } finally {
                suggestBtn.disabled = false;
                suggestBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Sugerir Temas';
            }
        }

        // Funci√≥n para mostrar las sugerencias
        function displaySuggestions(suggestions, source) {
            console.log('üìã Mostrando sugerencias:', suggestions);
            
            const suggestionsList = document.getElementById('suggestionsList');
            
            let suggestionsHtml = suggestions.map((suggestion, index) => `
                <div class="suggestion-item" onclick="useSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <div class="suggestion-text">
                        <strong>${index + 1}.</strong> ${suggestion}
                    </div>
                    <button class="suggestion-use" onclick="event.stopPropagation(); useSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                        Usar
                    </button>
                </div>
            `).join('');
            
            suggestionsHtml += `
                <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                    <button class="btn btn-outline-secondary btn-sm" onclick="suggestTopics()">
                        <i class="fas fa-sync"></i> Generar Nuevas Sugerencias
                    </button>
                    <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                        <i class="fas fa-robot"></i> Generado por: ${source === 'local-fallback' ? 'Sistema Local' : 'IA de BIOSKIN'}
                    </small>
                </div>
            `;
            
            suggestionsList.innerHTML = suggestionsHtml;
        }

        // Funci√≥n para usar una sugerencia
        function useSuggestion(suggestion) {
            console.log(`‚úÖ Usando sugerencia: ${suggestion}`);
            
            document.getElementById('customTopic').value = suggestion;
            showAlert('Tema aplicado. ¬°Ahora puedes generar el blog!', 'success');
            
            // Opcional: scroll al campo de tema para que el usuario vea el cambio
            document.getElementById('customTopic').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Highlight temporal del campo
            const topicInput = document.getElementById('customTopic');
            topicInput.style.background = '#fff3cd';
            topicInput.style.borderColor = '#ffeaa7';
            
            setTimeout(() => {
                topicInput.style.background = '';
                topicInput.style.borderColor = '';
            }, 2000);
        }

        console.log('‚úÖ Aplicaci√≥n lista');
        console.log('üîç Funciones disponibles:', {
            testConnection: typeof testConnection,
            generateBlog: typeof generateBlog,
            saveBlog: typeof saveBlog,
            diagnoseVercel: typeof diagnoseVercel,
            switchTab: typeof switchTab,
            previewChanges: typeof previewChanges,
            applyChanges: typeof applyChanges,
            saveBlogWithEdits: typeof saveBlogWithEdits,
            suggestTopics: typeof suggestTopics,
            useSuggestion: typeof useSuggestion
        });
        
        // Mostrar mensaje de bienvenida
        setTimeout(() => {
            showAlert('Sistema iniciado correctamente. Selecciona una categor√≠a y genera tu blog.', 'success');
        }, 1000);
    </script>
</body>
</html>